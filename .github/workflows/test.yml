name: Test Suite

# ── Trigger ──────────────────────────────────────────────────────────────────
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ── Required secrets (set in GitHub → Settings → Secrets → Actions) ──────────
# ANTHROPIC_API_KEY  — only needed for the integration job (never for unit)
# NEWSAPI_KEY        — only needed for the integration job (never for unit)
# CODECOV_TOKEN      — optional, for coverage upload

jobs:
  # ── Unit tests (fully offline, no real API keys needed) ───────────────────
  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.11", "3.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-test.txt

      - name: Run unit tests (offline, no slow/integration)
        run: |
          python -m pytest tests/ \
            -m "not integration and not slow" \
            -v --tb=short --no-header \
            --cov=. --cov-report=xml --cov-report=term-missing \
            --cov-omit="tests/*,deployment/*"
        env:
          DB_PATH: /tmp/test_trading.db
          ANTHROPIC_API_KEY: dummy_key_for_tests
          NEWSAPI_KEY: dummy_key_for_tests
          ALPHA_VANTAGE_KEY: ""

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11'
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # ── Schema validation ──────────────────────────────────────────────────────
  schema-check:
    name: Schema Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify all tables are created
        run: |
          python3 - <<'EOF'
          import sqlite3, sys, os
          os.environ["DB_PATH"] = "/tmp/schema_check.db"
          from storage.database import Database
          db = Database("/tmp/schema_check.db")

          expected = {
            "runs", "headline_scores", "technical_signals", "combined_signals",
            "risk_calculations", "strategy_signals", "strategy_performance",
            "scheduler_logs", "health_checks", "emergency_stops",
            "portfolio_snapshots", "portfolio_violations", "price_alerts",
            "optimization_results", "backtest_results", "screener_results",
            "backtest_strategy_comparison", "recovery_log",
          }

          conn   = sqlite3.connect("/tmp/schema_check.db")
          actual = {r[0] for r in conn.execute(
            "SELECT name FROM sqlite_master WHERE type='table'"
          ).fetchall()}
          conn.close()

          missing = expected - actual
          if missing:
            print(f"FAIL: missing tables: {missing}", file=sys.stderr)
            sys.exit(1)
          print(f"OK: all {len(expected)} tables present")
          EOF
        env:
          ANTHROPIC_API_KEY: dummy_key_for_tests
          NEWSAPI_KEY: dummy_key_for_tests

  # ── Integration tests (require real API keys — skipped if secrets absent) ──
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests        # only run after unit tests pass
    # Skip entire job when the secret is absent (forks, dependabot PRs, etc.)
    if: ${{ secrets.ANTHROPIC_API_KEY != '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-test.txt

      - name: Run integration tests
        run: |
          python -m pytest tests/ \
            -m "integration and not slow" \
            -v --tb=short --no-header
        env:
          DB_PATH: /tmp/integration_test.db
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}

  # ── Load test ─────────────────────────────────────────────────────────────
  load-test:
    name: Dashboard Load Test
    runs-on: ubuntu-latest
    needs: unit-tests    # only run if unit tests pass

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run load test
        run: |
          python tests/load_test_dashboard.py --users 10 --rows 1000
        env:
          DB_PATH: /tmp/load_test.db

  # ── Docker build verification ──────────────────────────────────────────────
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: news-trading-system:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify image starts
        run: |
          docker run --rm \
            -e DATABASE_URL="" \
            -e ANTHROPIC_API_KEY="dummy" \
            -e NEWSAPI_KEY="dummy" \
            news-trading-system:ci-${{ github.sha }} \
            python3 -c "from storage.database import Database; Database(); print('DB init OK')"

  # ── Code style (non-blocking) ────────────────────────────────────────────
  lint:
    name: Lint (non-blocking)
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff (report only)
        run: ruff check . --select E,W,F --ignore E501 --output-format=github || true
