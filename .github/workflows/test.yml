name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Unit + Integration tests ──────────────────────────────────────────────
  test:
    name: Unit & Integration Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run unit tests
        run: |
          python -m pytest tests/test_coordinator.py \
                           tests/test_risk_agent.py \
                           tests/test_technical_agent.py \
                           tests/test_recovery.py \
                           -v --tb=short --no-header \
                           --cov=. --cov-report=xml --cov-report=term-missing \
                           --cov-omit="tests/*,deployment/*"
        env:
          DB_PATH: /tmp/test_trading.db
          ANTHROPIC_API_KEY: dummy_key_for_tests
          NEWSAPI_KEY: dummy_key_for_tests

      - name: Run integration tests
        run: |
          python -m pytest tests/integration_test.py \
                           -v --tb=short --no-header
        env:
          DB_PATH: /tmp/integration_test.db
          ANTHROPIC_API_KEY: dummy_key_for_tests
          NEWSAPI_KEY: dummy_key_for_tests

      - name: Run resilience test
        run: |
          python scheduler/daily_runner.py --resilience-test
        env:
          DB_PATH: /tmp/resilience_test.db
          ANTHROPIC_API_KEY: dummy_key_for_tests
          NEWSAPI_KEY: dummy_key_for_tests

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11'
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # ── Load test ─────────────────────────────────────────────────────────────
  load-test:
    name: Dashboard Load Test
    runs-on: ubuntu-latest
    needs: test   # only run if unit/integration pass

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run load test
        run: |
          python tests/load_test_dashboard.py --users 10 --rows 1000
        env:
          DB_PATH: /tmp/load_test.db

  # ── Docker build verification ──────────────────────────────────────────────
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: news-trading-system:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify image starts
        run: |
          docker run --rm \
            -e DATABASE_URL="" \
            -e ANTHROPIC_API_KEY="dummy" \
            -e NEWSAPI_KEY="dummy" \
            news-trading-system:ci-${{ github.sha }} \
            python3 -c "from storage.database import Database; Database(); print('DB init OK')"

  # ── Schema validation ──────────────────────────────────────────────────────
  schema-check:
    name: Schema Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Verify all tables are created
        run: |
          python3 - <<'EOF'
          import sqlite3, sys, os
          os.environ["DB_PATH"] = "/tmp/schema_check.db"
          from storage.database import Database
          db = Database("/tmp/schema_check.db")

          expected = {
            "runs", "headline_scores", "technical_signals", "combined_signals",
            "risk_calculations", "strategy_signals", "strategy_performance",
            "scheduler_logs", "health_checks", "emergency_stops",
            "portfolio_snapshots", "portfolio_violations", "price_alerts",
            "optimization_results", "backtest_results", "screener_results",
            "backtest_strategy_comparison", "recovery_log",
          }

          conn   = sqlite3.connect("/tmp/schema_check.db")
          actual = {r[0] for r in conn.execute(
            "SELECT name FROM sqlite_master WHERE type='table'"
          ).fetchall()}
          conn.close()

          missing = expected - actual
          if missing:
            print(f"FAIL: missing tables: {missing}", file=sys.stderr)
            sys.exit(1)
          print(f"OK: all {len(expected)} tables present")
          EOF

  # ── Code style (non-blocking) ────────────────────────────────────────────
  lint:
    name: Lint (non-blocking)
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff (report only)
        run: ruff check . --select E,W,F --ignore E501 --output-format=github || true
